package main

import (
	"encoding/json"
	"fmt"
	"log"
	"os"

	"anything-tui/api"
	"anything-tui/config"
)

func main() {
	// You can set these env vars before running:
	// export AnythingLMM_URL="http://your-instance:3001"
	// export ANYTHINGLLM_API_KEY="your-key"

	cfg := config.Load()

	// Override for testing if needed, or rely on Load() defaults/env vars
	if os.Getenv("ANYTHINGLLM_API_KEY") == "" {
		fmt.Println("Warning: ANYTHINGLLM_API_KEY is not set. API calls might fail if auth is required.")
	}
	fmt.Printf("Using Base URL: %s\n", cfg.BaseURL)

	client := api.NewClient(cfg)

	fmt.Println("Fetching workspaces...")
	workspaces, err := client.ListWorkspaces()
	if err != nil {
		log.Fatalf("Error fetching workspaces: %v", err)
	}

	fmt.Printf("Found %d workspaces:\n", len(workspaces))
	for _, ws := range workspaces {
		fmt.Printf("- %s (ID: %d, Slug: %s)\n", ws.Name, ws.ID, ws.Slug)
	}

	workspace, gwsErr := client.GetWorkspace(workspaces[0].Slug)

	threads, err := client.ListThreads(workspaces[0].Slug)
	if err != nil {
		fmt.Println("fuck")
	}
	workspace.Threads = threads

	data, _ := json.Marshal(workspace)
	if gwsErr != nil {
		fmt.Printf("Error getting workspace: %v\n", gwsErr)
	} else {
		fmt.Printf("Found workspace: %s\n", data)
	}

	for _, th := range threads {
		data, _ := json.Marshal(th)
		fmt.Printf("%s", data)
	}
}
